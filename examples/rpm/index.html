
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>
  <script src="/js/vbg0.js"></script>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/agora-rtm-sdk@1.5.1/index.js"></script>
  <script src="/dist/networked-aframe.js"></script>
  <script src="/dist/naf-agora-adapter.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
  <script src="/js/Geometry.js"></script>

  <script>
    // Temporary workaround for template declaration; see issue 167
    NAF.schemas.getComponentsOriginal = NAF.schemas.getComponents;
    NAF.schemas.getComponents = (template) => {
      if (!NAF.schemas.hasTemplate('#head-template')) {
        NAF.schemas.add({
          template: '#head-template',
          components: [
            'position',
            'rotation',
            'player-info'
          ]
        });
      }
      const components = NAF.schemas.getComponentsOriginal(template);
      return components;
    };
  </script>

<script>
  AFRAME.registerComponent('player-info', {
    // notice that color and name are both listed in the schema; NAF will only keep
    // properties declared in the schema in sync.
    schema: {
      name: { type: 'string', default: 'user-' + Math.round(Math.random() * 10000) },
      gltfmodel: { type: 'string', default: '' }
    },

    init: function () {
      this.head = this.el.querySelector('.head');
      this.nametag = this.el.querySelector('.nametag');

      this.ownedByLocalUser = this.el.id === 'player';
      if (this.ownedByLocalUser) {
        // populate the html overlay with the correct name on init
        this.nametagInput = document.getElementById('username-overlay');
        this.nametagInput.value = this.data.name;
      }
    },

    // here as an example, not used in current demo. Could build a user list, expanding on this.
    listUsers: function () {
      console.log(
        'userlist',
        [...document.querySelectorAll('[player-info]')].map((el) => el.components['player-info'].data.name)
      );
    },

    update: function () {
      if (this.head) this.head.setAttribute('gltf-model', this.data.gltfmodel);
      if (this.nametag) this.nametag.setAttribute('value', this.data.name);
    }
  });
</script>


<style>
  .videoUI {
    position: fixed;
    bottom: 0px;
    left: 0px;
    width: 320px;
    height: 180px;
    z-index: 15;
    opacity:1.0;
    pointer-events: none; /* allow click-through in transparent areas */
}

  .frame {
      width: 90%;
      height: 90%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans,
          Droid Sans, Helvetica Neue, sans-serif;
      padding: 5%;
      padding-top: 2%;
      font-size: 14px;
      border: none;
      position: absolute;
      z-index: 1000;
  }

  .warning {
      background-color: #df68a2;
      padding: 3px;
      border-radius: 5px;
      color: white;
  }
</style>
</head>
<body>

<iframe id="frame" class="frame" allow="camera *; microphone *; clipboard-write" ihidden ></iframe>
<input
  id="username-overlay"
  style="z-index: 100; bottom: 24px; left: -1148px; position: fixed"
  oninput="document.getElementById('player').setAttribute('player-info', 'name', this.value)"
/>


<button
  id="gesture"
  style="z-index: 100; width:60px; height:60px; bottom: 24px; left: 24px; position: fixed"
  onclick="camera.start();"
>
  Click Me
</button>
<a-scene 
networked-scene="
      app: 20b7c51ff4c644ab80cf5a4e646b0537;
      room: {'name':'test1', 'vbg0':false, 'showLocal': false};
      connectOnLoad: false;
      debug: false;
      adapter: agorartc;
      audio: true;
      video: false;
    "

  renderer="colorManagement: true; physicallyCorrectLights:true;" light="defaultLightsEnabled: false"
>
  <a-assets>
    <template id="rig-template">
      <a-entity></a-entity>
    </template>

    <template id="head-template">
      <a-entity class="avatar" player-info networked-audio-source>
        <a-entity class="head" gltf-model="?" shadow="cast: true" rotation="0 180 0" position="0 -2.3 0"  scale="1.4 1.4 1.4" fix-avatar-rotation=""></a-entity> 

        <!-- here we add a text component for a nametag; the value will be updated by the player-info component -->
        <a-text
          class="nametag"
          value="?"
          rotation="0 180 0"
          position=".25 -.35 0"
          side="double"
          scale=".5 .5 .5"
        ></a-text>
      </a-entity>
    </template>
  </a-assets>


    <!-- Assets -->
    <a-assets>
      <a-asset-item id="hangari" src="assets/Hangar.glb"></a-asset-item>
      <a-asset-item id="nav_mesh" src="assets/Hangar_Navmesh.glb"></a-asset-item>
    </a-assets>

    <!-- Lights -->
    <a-entity id="DirectionalLight" position="0 10 -2"
      light="color: #ff000; intensity: 3.9; castShadow:  true; shadowCameraRight:  3;  shadowCameraBottom:  -3;  shadowCameraLeft:  -3; shadowCameraTop:  4 shadowBias:  -0.0001;  shadowRadius:  4">
    </a-entity>
    <a-entity id="AmbientLight" position="0 0 0"
      light="color: #000ff; type: ambient; intensity: 1.9; castShadow:  false">
    </a-entity>

    <!-- World -->
    <a-entity id="hangar" shadow="cast: false" visible="true" gltf-model="#hangari"></a-entity>
    <a-entity id="navmesh" visible="false" nav-mesh position="0.0 0.0 0.0" gltf-model="#nav_mesh"></a-entity>

  <a-entity id="rig" movement-controls networked="template:#rig-template;">
    <a-entity
      id="player"
      camera
      position="0 2.3 0"
      look-controls
      networked="template:#head-template;"
      visible="true"
    >  
    <a-entity id="self-view" 
    gltf-model="?" 
    position="0 -2.1 -0.25" rotation="-25 0 0" scale="1.1 1 1" ></a-entity>
   <!-- position="-2 -4.3 -1.4" rotation="-10 60 -2" scale="2 2 2" ></a-entity> -->
  </a-entity>
  </a-entity>
</a-scene>
 
<div class="videoUI" >
  <div class="video-canvas-container">
    <canvas id="canvas_secret" class="output_canvas" width="800px" height="600px"
      style="width:320px; height:180px; border: 0px solid white;"></canvas>
  </div>
  <div class="video-canvas-container" style="display:none; width: 320px; height: 180px; margin-top: 17px; margin-left: -186px; border: 1px solid white;">
    <video autoplay style="width: 320px; height: 180px;" id="local_video" class="player"></div>
  </div>
</div>

  <script src="./js/script.js"></script>

  <script>
    const constraints = {
                          video: { width: 640, height: 360 },
                          audio: true
                        };
  
    navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
     
      document.querySelector('a-scene').emit('connect')
    });
    </script>

<script>
  //displayIframe();
   //document.getElementById('player').setAttribute('player-info', 'gltfmodel', "./assets/RPM.glb"); 
</script>
</body>
</html>
